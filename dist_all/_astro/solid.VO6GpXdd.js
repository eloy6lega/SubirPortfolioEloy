const c={context:void 0,registry:void 0};function y(t){c.context=t}function H(){return{...c.context,id:`${c.context.id}${c.context.count++}-`,count:0}}let m=k;const p=1,w=2,S={owned:null,cleanups:null,context:null,owner:null};var l=null;let v=null,L=null,i=null,o=null,a=null,x=0;function O(t,e){const n=i,s=l,u=t.length===0,r=e===void 0?s:e,f=u?S:{owned:null,cleanups:null,context:r?r.context:null,owner:r},D=u?t:()=>t(()=>h(()=>E(f)));l=f,i=null;try{return b(D,!0)}finally{i=n,l=s}}function P(t,e,n){const s=U(t,e,!1,p);C(s)}function R(t,e,n){m=I;const s=U(t,e,!1,p);(!n||!n.render)&&(s.user=!0),a?a.push(s):C(s)}function h(t){if(i===null)return t();const e=i;i=null;try{return t()}finally{i=e}}function Q(t){R(()=>h(t))}function V(t){return l===null||(l.cleanups===null?l.cleanups=[t]:l.cleanups.push(t)),t}function F(t,e,n){let s=t.value;return(!t.comparator||!t.comparator(s,e))&&(t.value=e,t.observers&&t.observers.length&&b(()=>{for(let u=0;u<t.observers.length;u+=1){const r=t.observers[u],f=v&&v.running;f&&v.disposed.has(r),(f?!r.tState:!r.state)&&(r.pure?o.push(r):a.push(r),r.observers&&N(r)),f||(r.state=p)}if(o.length>1e6)throw o=[],new Error},!1)),e}function C(t){if(!t.fn)return;E(t);const e=x;$(t,t.value,e)}function $(t,e,n){let s;const u=l,r=i;i=l=t;try{s=t.fn(e)}catch(f){return t.pure&&(t.state=p,t.owned&&t.owned.forEach(E),t.owned=null),t.updatedAt=n+1,d(f)}finally{i=r,l=u}(!t.updatedAt||t.updatedAt<=n)&&(t.updatedAt!=null&&"observers"in t?F(t,s):t.value=s,t.updatedAt=n)}function U(t,e,n,s=p,u){const r={fn:t,state:s,updatedAt:null,owned:null,sources:null,sourceSlots:null,cleanups:null,value:e,owner:l,context:l?l.context:null,pure:n};return l===null||l!==S&&(l.owned?l.owned.push(r):l.owned=[r]),r}function g(t){if(t.state===0)return;if(t.state===w)return A(t);if(t.suspense&&h(t.suspense.inFallback))return t.suspense.effects.push(t);const e=[t];for(;(t=t.owner)&&(!t.updatedAt||t.updatedAt<x);)t.state&&e.push(t);for(let n=e.length-1;n>=0;n--)if(t=e[n],t.state===p)C(t);else if(t.state===w){const s=o;o=null,b(()=>A(t,e[0]),!1),o=s}}function b(t,e){if(o)return t();let n=!1;e||(o=[]),a?n=!0:a=[],x++;try{const s=t();return G(n),s}catch(s){n||(a=null),o=null,d(s)}}function G(t){if(o&&(k(o),o=null),t)return;const e=a;a=null,e.length&&b(()=>m(e),!1)}function k(t){for(let e=0;e<t.length;e++)g(t[e])}function I(t){let e,n=0;for(e=0;e<t.length;e++){const s=t[e];s.user?t[n++]=s:g(s)}if(c.context){if(c.count){c.effects||(c.effects=[]),c.effects.push(...t.slice(0,n));return}else c.effects&&(t=[...c.effects,...t],n+=c.effects.length,delete c.effects);y()}for(e=0;e<n;e++)g(t[e])}function A(t,e){t.state=0;for(let n=0;n<t.sources.length;n+=1){const s=t.sources[n];if(s.sources){const u=s.state;u===p?s!==e&&(!s.updatedAt||s.updatedAt<x)&&g(s):u===w&&A(s,e)}}}function N(t){for(let e=0;e<t.observers.length;e+=1){const n=t.observers[e];n.state||(n.state=w,n.pure?o.push(n):a.push(n),n.observers&&N(n))}}function E(t){let e;if(t.sources)for(;t.sources.length;){const n=t.sources.pop(),s=t.sourceSlots.pop(),u=n.observers;if(u&&u.length){const r=u.pop(),f=n.observerSlots.pop();s<u.length&&(r.sourceSlots[f]=s,u[s]=r,n.observerSlots[s]=f)}}if(t.owned){for(e=t.owned.length-1;e>=0;e--)E(t.owned[e]);t.owned=null}if(t.cleanups){for(e=t.cleanups.length-1;e>=0;e--)t.cleanups[e]();t.cleanups=null}t.state=0}function M(t){return t instanceof Error?t:new Error(typeof t=="string"?t:"Unknown error",{cause:t})}function d(t,e=l){throw M(t)}let T=!1;function W(){T=!0}function j(t,e){if(T&&c.context){const n=c.context;y(H());const s=h(()=>t(e||{}));return y(n),s}return h(()=>t(e||{}))}export{P as a,j as b,O as c,V as d,W as e,Q as o,c as s};
